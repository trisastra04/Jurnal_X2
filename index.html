<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Kelas Digital</title>
    
    <!-- Google Fonts: ADLaM Display & Oswald -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=ADLaM+Display&family=Oswald&display=swap" rel="stylesheet">

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for statistics pie chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Papa Parse for reading CSV login data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'ADLaM Display', cursive;
        }
        /* New class for the content font */
        .font-content {
            font-family: 'Oswald', sans-serif;
        }
        /* Make form elements inherit the body font by default */
        input, select, textarea, button {
            font-family: inherit;
        }
        .attendance-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .attendance-btn.active {
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .bg-h { background-color: #10b981; } /* emerald-500 */
        .bg-s { background-color: #f59e0b; } /* amber-500 */
        .bg-i { background-color: #3b82f6; } /* blue-500 */
        .bg-a { background-color: #ef4444; } /* red-500 */
        .bg-t { background-color: #a855f7; } /* purple-500 */
        .bg-p { background-color: #64748b; } /* slate-500 */

        /* Custom animation for modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Login Section -->
    <div id="login-section" class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
        <div>
            <h2 class="text-3xl font-bold text-center text-gray-800">Jurnal Kelas Digital</h2>
            <p class="text-center text-gray-500">Silakan masuk untuk melanjutkan</p>
        </div>
        <form id="login-form" class="space-y-6">
            <div>
                <label for="username" class="text-sm font-medium text-gray-700">ID Guru</label>
                <input id="username" name="username" type="text" required class="w-full px-4 py-2 mt-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent" placeholder="Masukkan ID Anda">
            </div>
            <div>
                <label for="password" class="text-sm font-medium text-gray-700">Password</label>
                <div class="relative mt-2">
                    <input id="password" name="password" type="password" required class="w-full px-4 py-2 pr-10 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-500 focus:border-transparent" placeholder="Masukkan Password">
                    <button type="button" id="togglePassword" class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10 12a2 2 0 100-4 2 2 0 000 4z" />
                            <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" />
                        </svg>
                        <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781zm4.261 4.26l1.514 1.515a2.003 2.003 0 012.45 2.45l1.514 1.514a4 4 0 00-5.478-5.478z" clip-rule="evenodd" />
                             <path d="M12.454 16.697L9.75 13.992a4 4 0 01-3.742-3.742L2.303 3.55a1 1 0 011.414-1.414l1.473 1.473A10.014 10.014 0 01.458 10C1.732 14.057 5.522 17 10 17a9.958 9.958 0 004.512-1.074l1.78 1.781a1 1 0 01-1.414 1.414l-3.429-3.43z" />
                        </svg>
                    </button>
                </div>
            </div>
            <p id="login-error" class="text-sm text-red-500 text-center hidden">ID atau Password salah. Coba lagi.</p>
            <div>
                <button type="submit" class="w-full py-3 font-semibold text-white bg-slate-700 rounded-lg hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 transition-colors duration-300">
                    Masuk
                </button>
            </div>
        </form>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden w-full max-w-4xl mx-auto p-4 md:p-6">
        <div class="bg-white rounded-xl shadow-lg">
            <!-- Header -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-800">Jurnal dan Absensi Kelas</h1>
                    <p id="teacher-name" class="text-sm text-gray-500">Selamat datang, </p>
                </div>
                <button id="logout-btn" class="flex items-center px-4 py-2 text-sm font-medium text-red-600 bg-red-100 rounded-lg hover:bg-red-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V5h10a1 1 0 100-2H3zm12.293 4.293a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 01-1.414-1.414L16.586 13H9a1 1 0 110-2h7.586l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Logout
                </button>
            </div>
            
            <!-- Form -->
            <form id="attendance-form" class="p-4 md:p-6 space-y-6">
                <!-- Input Data Kelas -->
                <div class="space-y-4 p-4 border rounded-lg bg-slate-50">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Input Data Kelas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="form-date-picker" class="block text-sm font-medium text-gray-700">Tanggal</label>
                            <input type="date" id="form-date-picker" name="Tanggal" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="mapel" class="block text-sm font-medium text-gray-700">Mata Pelajaran</label>
                            <select id="mapel" name="Mapel" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="jam-ke" class="block text-sm font-medium text-gray-700">Jam Ke</label>
                            <select id="jam-ke" name="Jam Ke" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"></select>
                        </div>
                        <div>
                            <label for="sampai" class="block text-sm font-medium text-gray-700">Sampai</label>
                            <select id="sampai" name="Sampai" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"></select>
                        </div>
                        <input type="hidden" id="form-teacher-name" name="Nama">
                    </div>
                </div>

                <!-- Student List -->
                <div class="space-y-4 p-4 border rounded-lg bg-slate-50">
                    <h3 class="text-lg font-medium text-gray-900 border-b pb-2">Absensi Siswa</h3>
                    <div class="flex flex-wrap gap-x-4 gap-y-2 text-xs text-gray-600 mt-2 mb-4 font-content">
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-h mr-1.5"></span>H: Hadir</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-s mr-1.5"></span>S: Sakit</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-i mr-1.5"></span>I: Izin</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-a mr-1.5"></span>A: Alpa</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-t mr-1.5"></span>T: Telat</div>
                        <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-p mr-1.5"></span>P: Pulang</div>
                    </div>
                    <!-- Header for the student list -->
                    <div class="hidden sm:flex items-center justify-between px-3 py-2 bg-slate-200 rounded-md text-sm font-semibold text-gray-600">
                        <div class="flex items-center flex-1">
                            <span class="w-8">No.</span>
                            <span>Nama Siswa</span>
                        </div>
                        <div class="w-48 text-center">Status Kehadiran</div>
                    </div>
                    <div id="student-list" class="space-y-2">
                        <!-- Student rows will be dynamically inserted here -->
                    </div>
                </div>
                
                <!-- Notes -->
                <div>
                    <label for="catatan" class="block text-sm font-medium text-gray-700">Catatan</label>
                    <textarea id="catatan" name="CATATAN" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-slate-500 focus:ring-slate-500 sm:text-sm font-content" placeholder="Masukkan catatan kegiatan belajar mengajar..."></textarea>
                </div>

                <!-- Submit Button -->
                <div class="pt-4 flex justify-end">
                    <button type="submit" id="submit-btn" class="inline-flex justify-center items-center py-2 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-slate-700 hover:bg-slate-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                        <span id="submit-btn-text">Kirim Absensi</span>
                        <div id="submit-btn-spinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-3"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white modal-fade-in">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Absensi Berhasil Dikirim!</h3>
                <div class="mt-4 px-7 py-3">
                    <p class="text-sm text-gray-500">Berikut adalah rekap kehadiran untuk sesi ini:</p>
                    <div class="w-full max-w-xs mx-auto mt-4">
                        <canvas id="attendance-chart"></canvas>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="close-modal-btn" class="px-4 py-2 bg-gray-800 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxiuPsV8hwIb5Z10D1Usg3aJdcZKpVzkoVDzglP9SDfv5fdAQoK2Kvxc4lv8re4wEOhyA/exec';
    const LOGIN_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTwT9XaQAUcv9X810Lj-71wJkzZjkGS2NNfqqfp4_9Qbfd8fWuTvVadOnKCQ7ltb6iJ3ldPtMM2a95w/pub?gid=1351893586&single=true&output=csv';
    
    const STUDENTS = [
        'ALFAHRIZI', 'ALHAN ZULFIKAR', 'ALIF ABIANSYAH', 'ALKA NOVALEN SYAH', 'ANDI ANJAS', 
        'ARYASATYA ROSYAD LANDRY', 'ATHAR LABIB SYAPUTRA', 'FAQIH AHMAD EL FAYYAD', 'M. SYAIR ALFATHIR',
        'M. ZACKA ASHOFA', 'MUHAMMAD FAJRI HIDAYAT', 'MUHAMMAD FATIH AL FAYADH', 'MUHAMMAD KHALIF AL MUBARAK',
        'MUHAMMAD RIDHO SETYAWAN', 'MUHAMMAD THARIG AZIYAD', 'MUHAMMAD ZAKY', 'THOIFAN ARIF HAFIZZAHIR',
        'WAN SULAIMAN', 'ZANI VAGEANSYAH'
    ];
    
    const SUBJECTS = [
        'PAI dan BP', 'PENDIDIKAN PANCASILA', 'BAHASA INDONESIA', 'BAHASA INGGRIS', 'MATEMATIKA', 'BIOLOGI',
        'FISIKA', 'KIMIA', 'GEOGRAFI', 'SEJARAH', 'SOSIOLOGI', 'EKONOMI', 'PJOK', 'SENI BUDAYA', 'INFORMATIKA'
    ];

    const ATTENDANCE_STATUS = {
        'H': { label: 'Hadir', color: '#10b981', bgColor: 'bg-h' },
        'S': { label: 'Sakit', color: '#f59e0b', bgColor: 'bg-s' },
        'I': { label: 'Izin', color: '#3b82f6', bgColor: 'bg-i' },
        'A': { label: 'Alpa', color: '#ef4444', bgColor: 'bg-a' },
        'T': { label: 'Telat', color: '#a855f7', bgColor: 'bg-t' },
        'P': { label: 'Pulang', color: '#64748b', bgColor: 'bg-p' }
    };
    
    // --- DOM ELEMENTS ---
    const loginSection = document.getElementById('login-section');
    const appSection = document.getElementById('app-section');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logout-btn');
    const attendanceForm = document.getElementById('attendance-form');
    const studentListContainer = document.getElementById('student-list');
    const mapelSelect = document.getElementById('mapel');
    const jamKeSelect = document.getElementById('jam-ke');
    const sampaiSelect = document.getElementById('sampai');
    const teacherNameDisplay = document.getElementById('teacher-name');
    const formTeacherNameInput = document.getElementById('form-teacher-name');
    const submitBtn = document.getElementById('submit-btn');
    const submitBtnText = document.getElementById('submit-btn-text');
    const submitBtnSpinner = document.getElementById('submit-btn-spinner');
    const successModal = document.getElementById('success-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const chartCanvas = document.getElementById('attendance-chart');
    const passwordInput = document.getElementById('password');
    const togglePasswordBtn = document.getElementById('togglePassword');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeSlashIcon = document.getElementById('eye-slash-icon');

    // --- APP STATE ---
    let teacherData = null;
    let usersData = [];
    let attendanceChart = null;

    // --- FUNCTIONS ---
    
    // Initialize the application
    const initApp = () => {
        // Check session storage for logged in user
        const storedUser = sessionStorage.getItem('teacherData');
        if (storedUser) {
            teacherData = JSON.parse(storedUser);
            showApp();
        } else {
            showLogin();
            fetchUsers();
        }
    };

    // Fetch user credentials from CSV
    const fetchUsers = () => {
        Papa.parse(LOGIN_CSV_URL, {
            download: true,
            header: false,
            complete: (results) => {
                usersData = results.data.map(row => ({
                    id: row[0],
                    password: row[1],
                    name: row[2],
                    mapel: row[3]
                }));
            },
            error: (err) => {
                console.error("Gagal mengambil data login:", err);
                loginError.textContent = "Gagal terhubung ke server login.";
                loginError.classList.remove('hidden');
            }
        });
    };

    // Handle login
    const handleLogin = (e) => {
        e.preventDefault();
        const username = loginForm.username.value;
        const password = loginForm.password.value;

        const foundUser = usersData.find(user => user.id === username && user.password === password);

        if (foundUser) {
            teacherData = foundUser;
            sessionStorage.setItem('teacherData', JSON.stringify(teacherData));
            showApp();
        } else {
            loginError.classList.remove('hidden');
        }
    };

    // Handle logout
    const handleLogout = () => {
        teacherData = null;
        sessionStorage.removeItem('teacherData');
        showLogin();
    };

    // Show login screen
    const showLogin = () => {
        appSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
        loginForm.reset();
        loginError.classList.add('hidden');
    };

    // Show main application
    const showApp = () => {
        loginSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        populateForm();
    };

    // Populate form with data
    const populateForm = () => {
        // Populate teacher name
        teacherNameDisplay.textContent = `Selamat datang, ${teacherData.name}`;
        formTeacherNameInput.value = teacherData.name;

        // Set date
        const formDatePicker = document.getElementById('form-date-picker');
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        formDatePicker.value = `${yyyy}-${mm}-${dd}`;

        // Populate dropdowns
        mapelSelect.innerHTML = SUBJECTS.map(subject => `<option value="${subject}">${subject}</option>`).join('');
        jamKeSelect.innerHTML = Array.from({length: 7}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');
        sampaiSelect.innerHTML = Array.from({length: 7}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('');

        // Set default mapel for teacher
        if (teacherData.mapel && SUBJECTS.includes(teacherData.mapel)) {
            mapelSelect.value = teacherData.mapel;
        }

        // Populate student list
        studentListContainer.innerHTML = ''; // Clear previous list
        STUDENTS.forEach((student, index) => {
            const studentRow = document.createElement('div');
            studentRow.className = 'flex flex-col sm:flex-row items-start sm:items-center justify-between p-3 bg-white rounded-lg border';
            studentRow.dataset.studentName = student;

            const nameWrapper = document.createElement('div');
            nameWrapper.className = 'flex items-center mb-2 sm:mb-0 flex-1';

            const numberEl = document.createElement('span');
            numberEl.className = 'w-8 text-gray-500 font-medium';
            numberEl.textContent = `${index + 1}.`;

            const studentNameEl = document.createElement('p');
            studentNameEl.className = 'font-medium text-gray-800';
            studentNameEl.textContent = student;
            
            nameWrapper.appendChild(numberEl);
            nameWrapper.appendChild(studentNameEl);

            const attendanceButtons = document.createElement('div');
            attendanceButtons.className = 'flex items-center space-x-1 sm:w-48 justify-start sm:justify-center self-end sm:self-center';

            Object.keys(ATTENDANCE_STATUS).forEach(status => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.status = status;
                button.textContent = status;
                // Default to 'Hadir'
                const isActive = status === 'H';
                button.className = `attendance-btn w-8 h-8 rounded-md font-bold text-sm ${isActive ? ATTENDANCE_STATUS[status].bgColor + ' active' : 'bg-white'}`;
                attendanceButtons.appendChild(button);
            });

            studentRow.appendChild(nameWrapper);
            studentRow.appendChild(attendanceButtons);
            studentListContainer.appendChild(studentRow);
        });
    };

    // Handle clicking attendance buttons
    const handleAttendanceClick = (e) => {
        if (e.target.classList.contains('attendance-btn')) {
            const clickedBtn = e.target;
            const parent = clickedBtn.parentElement;
            
            // Remove active class from siblings
            parent.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.classList.remove('active', ...Object.values(ATTENDANCE_STATUS).map(s => s.bgColor));
                btn.classList.add('bg-white');
            });
            
            // Add active class to clicked button
            const status = clickedBtn.dataset.status;
            clickedBtn.classList.add('active', ATTENDANCE_STATUS[status].bgColor);
            clickedBtn.classList.remove('bg-white');
        }
    };

    // Handle form submission
    const handleFormSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);

        // Membuat objek 'attendance' sesuai struktur yang diharapkan skrip
        const attendancePayload = {};
        document.querySelectorAll('[data-student-name]').forEach(row => {
            const studentName = row.dataset.studentName;
            const activeBtn = row.querySelector('.attendance-btn.active');
            const status = activeBtn ? activeBtn.dataset.status : 'H';
            attendancePayload[studentName] = status;
        });
        
        // Membuat objek payload utama dalam format JSON
        const formDatePicker = document.getElementById('form-date-picker');
        const dateValue = formDatePicker.value; // Format: "YYYY-MM-DD"
        const [year, month, day] = dateValue.split('-');
        const formattedDateForSheet = `${day}/${month}/${year}`; // Format: "DD/MM/YYYY"

        const dataToSend = {
            timestamp: new Date().toISOString(),
            teacherName: formTeacherNameInput.value,
            date: formattedDateForSheet,
            subject: mapelSelect.value,
            period: jamKeSelect.value,
            endPeriod: sampaiSelect.value,
            attendance: attendancePayload,
            notes: document.getElementById('catatan').value
        };

        try {
            // Mengirim data sebagai string JSON. Google Apps Script akan membacanya
            // dari properti e.postData.contents.
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(dataToSend),
                headers: {
                    // Mengirim sebagai text/plain untuk menghindari permintaan preflight CORS (OPTIONS)
                    // yang seringkali tidak ditangani oleh skrip Google Apps sederhana.
                    'Content-Type': 'text/plain;charset=utf-8',
                }
            });

            const result = await response.json();

            if (result && result.success) {
                showSuccessModal();
                attendanceForm.reset(); 
                populateForm(); 
            } else {
                throw new Error(result.error || 'Gagal mengirim data. Skrip Google merespons dengan kesalahan.');
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('Terjadi kesalahan saat mengirim data: ' + error.message);
        } finally {
            setLoading(false);
        }
    };
    
    // Set loading state for submit button
    const setLoading = (isLoading) => {
        if (isLoading) {
            submitBtn.disabled = true;
            submitBtnText.classList.add('hidden');
            submitBtnSpinner.classList.remove('hidden');
        } else {
            submitBtn.disabled = false;
            submitBtnText.classList.remove('hidden');
            submitBtnSpinner.classList.add('hidden');
        }
    };

    // Show success notification modal and pie chart
    const showSuccessModal = () => {
        const stats = { H: 0, S: 0, I: 0, A: 0, T: 0, P: 0 };
        document.querySelectorAll('[data-student-name]').forEach(row => {
            const activeBtn = row.querySelector('.attendance-btn.active');
            const status = activeBtn ? activeBtn.dataset.status : 'H';
            stats[status]++;
        });

        const chartData = {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [],
                hoverOffset: 4
            }]
        };

        for (const [status, count] of Object.entries(stats)) {
            if (count > 0) {
                chartData.labels.push(`${ATTENDANCE_STATUS[status].label} (${count})`);
                chartData.datasets[0].data.push(count);
                chartData.datasets[0].backgroundColor.push(ATTENDANCE_STATUS[status].color);
            }
        }

        if (attendanceChart) {
            attendanceChart.destroy();
        }

        attendanceChart = new Chart(chartCanvas, {
            type: 'pie',
            data: chartData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    label += context.parsed;
                                }
                                return label;
                            }
                        }
                    }
                }
            },
        });

        successModal.classList.remove('hidden');
    };

    // Hide success modal
    const hideSuccessModal = () => {
        successModal.classList.add('hidden');
    };

    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', handleLogin);
    logoutBtn.addEventListener('click', handleLogout);
    studentListContainer.addEventListener('click', handleAttendanceClick);
    attendanceForm.addEventListener('submit', handleFormSubmit);
    closeModalBtn.addEventListener('click', hideSuccessModal);

    togglePasswordBtn.addEventListener('click', () => {
        const isPassword = passwordInput.type === 'password';
        passwordInput.type = isPassword ? 'text' : 'password';

        eyeIcon.classList.toggle('hidden');
        eyeSlashIcon.classList.toggle('hidden');
    });

    // --- INITIALIZATION ---
    initApp();
});
</script>

</body>
</html>


